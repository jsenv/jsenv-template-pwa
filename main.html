<!DOCTYPE html>
<html lang="en">
  <head>
    <title>PWA Example</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="./icons/favicon.png" />
    <link rel="manifest" href="./pwa.webmanifest" />
    <link rel="stylesheet" href="./src/app/app.css" />
    <script type="importmap" src="./dev.importmap"></script>
    <!--
    Why dev.importmap?
    -> We want to execute this file in "development" mode meaning you we
    can add custom behaviour to help developper experience.
    When this file is built, the importmap is replaced by "prod.importmap".
    This will remove code specific to development thanks to treeshaking.
    -->

    <!--
    Explanation of this HTMl file and why it's the way it is

    First thing user sees is the HTML in this file. If HTML was empty,
    user would see a blank page. To have something better to show, there is
    inline HTML, CSS and JS to immediatly display something called "splashscreen".

    splashscreen has several reponsabilities:
    1. Be the first thing a user see
    2. Load the main js file from network (boot/boot.js)
    3. When loading main js takes times, invite user to wait
    4. When loading fails (due to a network error), display an error message
    5. When main js file throws, display an error message

    As splashscreen is inline it is displayed instantly to the user.
    As it is inlined, splashscreen should be small and simple.
    This project enrich the splashscreen inside boot/boot.js to provide a
    better loading experience.

    From user point of view it goes like this:
    1. splashscreen is immediatly displayed
    2. Very shortly after JS and CSS improves the loading experience (when app_loader.js executes)
    3. splashscreen fades away and website is displayed (when app.js is executed by app_loader.js)
    -->
    <link
      rel="preload"
      href="./src/boot/roboto-v27-latin-regular.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link rel="preload" href="./src/boot/boot.js" as="script" crossorigin />
    <link rel="preload" href="./src/app/app.js" as="script" crossorigin />

    <!-- TODO: explain boot.css and data-jsenv-force-inline  -->
    <link rel="stylesheet" href="./src/boot/boot.css" data-jsenv-force-inline />
  </head>

  <body>
    <noscript>
      <h1>JavaScript is required</h1>
      <p>This page needs JavaScript to run but JavaScript is not available</p>
    </noscript>
    <div id="browser_not_supported">
      <h1>Browser not supported</h1>
      <p>Please update your internet browser or try with an other one</p>
    </div>
    <div id="app" data-booting></div>
    <div id="splashscreen">
      <div id="splashscreen_logo">
        <img src="./src/logo.png" data-jsenv-force-inline />
      </div>
      <div id="splashscreen_brand">PWA template</div>
      <div id="splashscreen_message"></div>
      <div style="display: none">
        <div id="booting_start"></div>
        <div id="booting_is_slow">Booting...</div>
        <div id="booting_error">
          <p>An error occured while booting</p>
          <br />
          <details>
            <summary>See error stack</summary>
            <pre id="boot_runtime_error_stack">${errorStack}</pre>
          </details>
        </div>
      </div>
    </div>

    <!--
      "browser_support_detection.js" file sets window.browserIsSupported
      It will be used to either
      - Display "browser not supported" message
      - Or booting the application

      [data-jsenv-force-inline] attribute inlines the js file content in this HTML during the build
    -->
    <script
      src="./src/boot/browser_support_detection.js"
      data-jsenv-force-inline
    ></script>
    <script
      type="module"
      src="./src/boot/boot.js"
      data-jsenv-force-inline
    ></script>
    <script>
      // We must listen to "beforeinstallprompt" as soon as possible or it could be missed.
      // Event is stored in window.beforeinstallpromptEvent to be used later
      window.addEventListener(
        "beforeinstallprompt",
        (beforeinstallpromptEvent) => {
          beforeinstallpromptEvent.preventDefault()
          window.beforeinstallpromptEvent = beforeinstallpromptEvent
        },
      )
    </script>
  </body>
</html>
