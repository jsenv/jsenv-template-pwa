# import resolution

This codebase relies on standard import resolution used in web browsers. It also uses [importmap](https://github.com/WICG/import-maps#import-maps) to control import resolution.

Importmap file is used for [import aliases](#import-aliases), [node module resolution](#node-module-resolution) and to [configure ESLint and VSCode](#configure-eslint-and-vscode)

> At the time of writing this documentation, _importmap_ are supported only by chrome so files are transformed in dev and during build to be compatible with other browsers.

# import aliases

```js
import { add } from "../../src/add.js"
// can and should be written
import { add } from "root/src/add.js"
```

Thanks to import aliases import paths can be consistent: they always start from an alias and specify the file path from there:

- no `../../../` hell
- file can be moved without having to update import inside that file
- easy search and replace in the codebase

If you want to keep import aliases, check [How to use import aliases](#How-to-use-import-aliases). Otherwise see [How to remove import aliases](#How-to-remove-import-aliases).

## How to use import aliases

import aliases are configured using `"initialImportMap"` in [script/generate_importmap.mjs](../../script/importmap/generate_importmap.mjs).
Feel free to update these mappings you like but it is recommended to keep the number of import aliases to the strict minimum.

## How to remove import aliases

1. Replace all `"root/*"` paths with a relative notation: `"./*"` or `"../*"`
2. Remove mappings from `"initialImportMap"` in [script/generate_importmap.mjs](../../script/importmap/generate_importmap.mjs)

# node module resolution

Thanks to node module resolution, some bare import are remapped to a real file location. For example, as long as `"lodash"` is in your _package.json_ `"dependencies"` or `"devDependencies"`, the following import:

```js
import "lodash"
```

is remapped to something like `"./node_modules/lodash/index.js"`.

If you want to keep node module resolution, check [How to use node module resolution](#How-to-use-node-module-resolution). Otherwise see [How to remove node module resolution](#How-to-remove-node-module-resolution).

# How to use node module resolution

When html loads js relying on node module resolution, this html must use an importmap.
And the importmap must contain mappings corresponding to node module resolution.
There is two importmap files generated with these mappings:

- _dev.importmap_
- _prod.importmap_

These files are generated after every `npm install` and can be generated on demand by `npm run generate-importmap`.

| Scenario                                                       | Importmap file to use |
| -------------------------------------------------------------- | --------------------- |
| Code imports only from "dependencies" declared in package.json | prod.importmap        |
| Code imports from "dependencies" and "devDependencies"         | dev.importmap         |

You should rerun `npm run generate-importmap` when something impacting _node esm resolution algorithm_ happens. It means when any of the following fields has changed in your _package.json_: `"name"`, `"imports"`, `"exports"`, `"dependencies"`, `"devDependencies"`.

In practice it happens in 3 scenarios:

1. You update manually `"name"`, `"imports"` or `"exports"` field.
2. You install a new dependency with `npm install <package-name>`
3. You uninstall a dependency with `npm uninstall <package-name>`

## How to remove node module resolution

1. Remove `"mappingsForNodeResolution"` in [script/importmap/generate_importmap.mjs](../../script/importmap/generate_importmap.mjs)

# Configure ESLint and VSCode

ESLint is configured to resolve import using _dev.importmap_ by `importMapFileRelativeUrl` in [.eslintrc.cjs](../../.eslintrc.cjs#L54).

VSCode is aware of import mappings thanks to _jsconfig.json_ generated by `npm run generate-importmap`.
